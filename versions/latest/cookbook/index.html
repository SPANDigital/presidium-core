

<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayerPro</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/playerpro/assets/shared/css/reset.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="/playerpro/assets/shared/css/bootstrap.min.css">
    <link rel="stylesheet" href="/playerpro/assets/shared/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/playerpro/assets/shared/css/style.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="/playerpro/assets/shared/css/prism.css" type="text/css" media="screen"/>

    <!-- Fonts -->
    <link href='http://fonts.googleapis.com/css?family=Roboto:300,500' rel='stylesheet' type='text/css'>

    <script src="/playerpro/assets/shared/js/session-capture.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="/playerpro/assets/shared/js/respond.min.js"></script>
    <script src="/playerpro/assets/shared/js/prism.js"></script>

    <!--[if lt IE 9]>
    <script src="/playerpro/assets/shared/js/html5.js"></script>
    <![endif]-->

    <!--

This file gets included in the <head></head> section of the main layout pages.  It allows you to add in additional
overriding stylesheets and / or JavaScript libraries that you might require in your project.

Note: Please prefix all the included links with /playerpro, for example:

      <link rel="stylesheet" href="/playerpro/assets/local/css/style.css" type="text/css" media="screen"/>
-->


</head>
<body class="products">

    <div id="holder" class="mainholder">

        <!-- Results panel -->
        <div id="wrapper">
            <div id="sidebar-wrapper">
                <aside>
                    <article>
                        <h2>Definition</h2>
                        <p>content here for results</p>
                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec pretium metus vitae urna pharetra fermentum. Nunc convallis ligula nec accumsan mollis.</p>
                        <div class="divider"></div>
                        <h2>Results formula</h2>
                        <p> Something here <span class="light">A highlight</span><br>
                    </article>
                </aside>
            </div>
        </div>

        <!--header-->
<section id="page-head">
	<!--logo-->
	<!--<header id="logo">-->
			<!--<a href=""><img src="/playerpro/assets/local/images/company_logo.png" alt=""></a>-->
	<!--</header>-->
	<!--menu-->
	<!-- <nav id = "topnav">
	    <ul>
	        <li>
	            <a href="/products/">PRODUCTS</a>
	            <a href="/classes/">CLASSES</a>
	            <a href="/events/">EVENTS</a>
	            <a href="/pangaea-onboarding/">ONBOARDING</a>
	        </li>
	    </ul>
	</nav> -->
</section>


        <!--CONTENT with sidebar left-->
        <section id="onebar" class="leftbar">
            <!--CONTENT right-->

            <section id="rightpage">
                <article id="cookbook" class="reference">
					<!--<a href="#menu-toggle" class="togglebut" id="menu-toggle">Toggle Results Panel</a>-->

                   <h1 class="primary">COOKBOOK</h1>

<h1 id="decaching-multiple-user-caches" class="secondary">Decaching Multiple User Caches</h1>
<article>
    <div class="article-meta">
        
        <span class="date"></span>
    </div>
    <div class="article-content">
        <h1 id="solution">Solution</h1>

<p>Users perform a GET for a resource against the PlayerPro API. If so
desired, the relationship between the entity and user may be recorded in
Redis for use at a later stage when the Job Service would be required
to invalidate all users who have a cached version of that resource.</p>

<p>Currently this relationship is determined by querying an external API.
In future a cache hook could easily query a redis store for this
information.</p>

<p>The first step to supporting this behaviour, is to adjust the Job
Service configuration rules to create a job from the events spawned as a
result of a GET against the PlayerPro API.</p>

<p>For the purposes of illustration, assume that the PlayerPro API caches
the GETs of <code class="highlighter-rouge">posts</code>: <code class="highlighter-rouge">GET /posts/&lt;int:post_id&gt;</code>, and this is
done per user. The cache keys in the Redis store will look like:
<code class="highlighter-rouge">/posts/&lt;int:post_id&gt;?access_token=users_access_token</code>.</p>

<p>The events that are pushed to the Job Service, can be converted into
jobs by using the following configuration:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">job_scheduler</span><span class="pi">:</span>
  <span class="s">job_rules</span><span class="pi">:</span>
    <span class="c1"># ...</span>
    <span class="pi">-</span> <span class="pi">{</span> <span class="nv">action_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">^(Read)$"</span><span class="pi">,</span> <span class="nv">resource_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Posts"</span><span class="pi">,</span> <span class="nv">topic</span><span class="pi">:</span> <span class="s2">"</span><span class="s">pp-cache"</span> <span class="pi">}</span>
    <span class="c1"># ...</span>
    <span class="s">enricher</span><span class="pi">:</span>
    <span class="s">topics</span><span class="pi">:</span>
      <span class="s">pp-cache</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">match</span><span class="pi">:</span>
            <span class="pi">{</span> <span class="nv">action_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Read"</span><span class="pi">,</span> <span class="nv">resource_type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Posts"</span> <span class="pi">}</span>
          <span class="s">key_fields</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s1">'</span><span class="s">payload'</span>
            <span class="pi">-</span> <span class="s1">'</span><span class="s">expires'</span>
            <span class="pi">-</span> <span class="s1">'</span><span class="s">due'</span>
            <span class="pi">-</span> <span class="s1">'</span><span class="s">priority'</span>
            <span class="pi">-</span> <span class="s1">'</span><span class="s">job_type'</span>
          <span class="s">job_properties</span><span class="pi">:</span>
              <span class="pi">{</span> <span class="nv">superceedable</span><span class="pi">:</span> <span class="nv">True</span><span class="pi">,</span> <span class="nv">job_type</span><span class="pi">:</span> <span class="s1">'</span><span class="s">cache'</span><span class="pi">,</span> <span class="nv">priority</span><span class="pi">:</span> <span class="nv">1</span><span class="pi">,</span> <span class="nv">due</span><span class="pi">:</span> <span class="nv">0</span><span class="pi">,</span> <span class="nv">expires</span><span class="pi">:</span> <span class="nv">5</span> <span class="pi">}</span></code></pre></figure>

<p>Above, the routing rule indicates that a cache related job needs to be
created. In the enricher config, a <code class="highlighter-rouge">cache</code> job is specified as the
job type, not <code class="highlighter-rouge">invalidate</code>.</p>

<p>In the Job Manager, the cache hook can be adjusted to handle a
<code class="highlighter-rouge">cache</code> job.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s">'invalidate'</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
    <span class="n">new_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_jobs</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">job_rules</span><span class="p">)</span>
 <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s">'cache'</span><span class="p">:</span>
    <span class="c"># Cache the relationship.</span></code></pre></figure>

<p>Here, the logic to retrieve the <code class="highlighter-rouge">access_token</code> and <code class="highlighter-rouge">entity_id</code>
(Post Id), maybe be inserted. The job will have this information as part
of its attributes. The insertion mechanism will simply index by
<code class="highlighter-rouge">entity_id</code>, and return a list of access tokenâ€™s associated with
this list, new tokens can be appended to this list. and the result
cached.</p>

<h1 id="discussion">Discussion</h1>

<p>This solution has some advantages over the incumbent: most importantly
it prevents the hook from having to query a slow API endpoint to
retrieve users associated with the resource. Moreover, it leverages
existing events produced by the PlayerPro API, and maintains the purity
of the API by not introducing work that is semantically different from
its intended purpose.</p>

    </div>
</article>


                </article>
            </section>

            <aside>
                <!--Product Logo-->
                <article>
                    
                        <a href="index.html" class="sublogo"><img src="/playerpro/assets/local/images/project_logo.png" alt=""></a>
                    
                    <h4>Version</h4>

                    <div id="bar-select">
                        <select>
                            <option value="/playerpro/versions/latest/">Latest</option>
                            
                                <option value="/playerpro/versions/"></option>
                            
                                <option value="/playerpro/versions/"></option>
                            
                        </select>
                    </div>
                </article>
                <div id="nav-container">
                    <!--left sub navigation-->
<nav id="sidenav">
    <h2>DOCUMENTATION</h2>
    <ul class="nav">
        
            
            

            
                
                
                <li>
                    <a href="/playerpro/#overview" data-target="#overview">Overview</a>
                    <ul>
                        
                    </ul>
                </li>
            
         
            
            

            
                
                
                <li>
                    <a href="/playerpro/key-concepts#key-concepts" data-target="#key-concepts">Key Concepts</a>
                    <ul>
                        
                    </ul>
                </li>
            
         
            
            

            
                
                
                <li>
                    <a href="/playerpro/prerequisites#prerequisites" data-target="#prerequisites">Prerequisites</a>
                    <ul>
                        
                    </ul>
                </li>
            
         
            
            

            
                
                
                <li>
                    <a href="/playerpro/getting-started#getting-started" data-target="#getting-started">Getting started</a>
                    <ul>
                        
                    </ul>
                </li>
            
         
            
            

            
                
                
                <li>
                    <a href="/playerpro/best-practices#best-practices" data-target="#best-practices">Best Practices</a>
                    <ul>
                        
                    </ul>
                </li>
            
         
            
            

            
                
                
                <li>
                    <a href="/playerpro/references#reference" data-target="#reference">Reference</a>
                    <ul>
                        
                            
                            
                                <li>
                                    <a onclick="$('#dropdown-menu-api').toggleClass('hidden');" >
                                        API
                                        <span class="caret"></span>
                                    </a>
                                    <ul id="dropdown-menu-api" class="hidden">
                                        
                                        <li class="sub-menu-item">
                                            <a href="/playerpro/references#playerpro-python-flask-api" data-target="#playerpro-python-flask-api">PlayerPro Python/FLASK API</a>
                                        </li>
                                        
                                    </ul>
                                </li>
                            
                        
                    </ul>
                </li>
            
         
            
            

            
                
                
                <li>
                    <a href="/playerpro/cookbook#cookbook" data-target="#cookbook">Cookbook</a>
                    <ul>
                        
                    </ul>
                </li>
            
         
            
            

            
                
                
                <li>
                    <a href="/playerpro/tools#tools" data-target="#tools">Tools</a>
                    <ul>
                        
                    </ul>
                </li>
            
         
            
            

            
                
                
                <li>
                    <a href="/playerpro/testing#testing-debugging" data-target="#testing-debugging">Testing & Debugging</a>
                    <ul>
                        
                    </ul>
                </li>
            
         
            
            

            
                <li>
                    <a onclick="$('#dropdown-menu-updates').toggleClass('hidden');" >
                        Updates
                        <span class="caret"></span>
                    </a>
                    <ul id="dropdown-menu-updates" class="hidden">
                        
                        <li class="sub-menu-item">
                            <a href="/playerpro/updates#job-service-0-1-2"  data-target="#job-service-0-1-2">Job Service 0.1.2</a>
                        </li>
                        
                        <li class="sub-menu-item">
                            <a href="/playerpro/updates#api-3-1-4"  data-target="#api-3-1-4">API 3.1.4</a>
                        </li>
                        
                    </ul>
                </li>
            
         
    </ul>
</nav>


<!--href="/playerpro#"></a>-->

                    <article>
                        <h4>Contact the team</h4>
						<span class="button icon-slack"><a href="https://spandigital.slack.com/messages/player-pro/" target="_blank">player-pro</a></span>
                    </article>
                </div>
            </aside>
        </section>

        <!-- footer 
Commenting out the footer until we get content... :-)
so not to break layout - is also hidden in the style.css footer-->

<section id="page-foot">
	<!-- <footer class="footer">
      <div class="container">
        <h2></h2>
		<p>&copy; August 2015 [ <a href="/">Lorem Ipsum</a> ] All rights reserved | </p>
      </div>
    </footer>-->
</section>

    </div>

    <script>
        $(document).ready(function() {
            $('#nav-container').affix({
                offset: {
                    top: 200,
                    bottom: function () {
                        return (this.bottom = $('.footer').outerHeight(true) + 12)
                    }
                }
            });

            $('#nav-container').on('affix.bs.affix', function() {
                $('#nav-container').removeAttr('style');
            });
            $('body').scrollspy({
                target: '#sidenav'
            });
        })
    </script>
<!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
		$("#menu-toggle").toggleClass("toggleon");
    });
    </script>
</body>
